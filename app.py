import streamlit as st
import matplotlib.pyplot as plt
import numpy as np
import altair as alt
import pandas as pd

st.title("🎬 电影版《思想辩证区域》测试题")
st.write("请直觉作答，不要思考太久，每题选出你认同的选项（可多选）。")

# 定义所有维度初始值
dimensions = {
    "非女权 ↔ 女权": 0,
    "保守 ↔ 开放": 0,
    "商业 ↔ 独立": 0,
    "经典 ↔ 先锋": 0,
    "大众影迷 ↔ 硬核影迷": 0
}

# 每个子维度的解释
subdimension_analysis = {
    "女权": "你敏锐地捕捉到性别不平等的存在，关心电影中女性角色的处境与命运。你可能会因为一句台词、一场女性觉醒的戏痛哭，甚至时不时会推荐朋友看《燃烧女子的肖像》。你相信电影可以是政治的，也是温柔的，最打动你的，是那些细腻却坚定的抗争瞬间。",
    
    "非女权": "你更偏爱稳定的社会结构和传统的性别分工，欣赏那些讲述家庭、责任与坚韧的故事。你可能更容易被母亲角色的无私、妻子角色的奉献打动，对过于激进的政治表达保持一定距离。你相信，安静也是一种力量。",

    "开放": "你是个天生共情力强的人，对多元文化与边缘声音始终保持好奇。无论是少数族裔、LGBTQ+、移民叙事，还是底层视角的表达，你都愿意倾听和理解。你也许并不追求叛逆，而是更相信世界不只一种样子，电影正是连接彼此的方式。",

    "保守": "你重视秩序与情感的稳定，对家庭、传统、道德有天然的亲近感。你喜欢那些温暖但不煽情的作品，也愿意一次次重温经典，寻找熟悉的慰藉。你相信好电影能修复人心，能让人更善良地活着。",

    "先锋": "你讨厌被套路，看一眼海报就能猜中剧情的片子你根本不屑一顾。你偏爱形式的突破与结构的实验——倒叙、碎片、开放式结局都让你如鱼得水。你可能是那种在朋友都看不懂时偷偷兴奋的人，也可能梦想有朝一日自己拍一部“没人看懂但很牛的片”。",

    "经典": "你是个对电影语言极度讲究的人，钟爱黑白影像、长镜头与隐喻丰沛的叙事方式。你熟悉电影史、影评圈与 Criterion Collection，并且觉得《日出》《卡萨布兰卡》《霸王别姬》这些永远不该被遗忘。你会因为一段光影构图激动，也尊敬那些遵循“好故事”的导演。",

    "商业": "你热爱影院里爆米花的味道，爱大片扑面而来的震撼与节奏感。你不介意套路，甚至享受它带来的熟悉感。你相信电影是情绪的释放，而不是智力的角力。对你来说，《阿凡达》《盗梦空间》这类大片就是快乐的源泉，没必要每部片子都要讲道理。",

    "独立": "你不太相信主流视角，宁愿花时间看一部豆瓣冷门高分片，也不想跟风打卡爆款。你喜欢导演的个人表达，甚至有时会原谅一部片子的混乱，只因为它“很真”。你可能也喜欢文学、诗歌，电影对你而言，是另一个维度的思考工具。",

    "大众影迷": "你把电影当作生活的一部分，和朋友约着看新片、一起吐槽烂片、为了彩蛋等到片尾都不走。你可能不纠结评分表或影史地位，但总能从电影中找到共鸣和情绪出口。对你来说，看电影是快乐、是陪伴、是和世界保持联系的一种方式。",

    "硬核影迷": "你不仅看电影，还会研究它。你可能有豆瓣标记癖，Letterboxd 刷榜狂热症，甚至维护过自己的影单 Excel。你喜欢拍摄技法、电影语言、文化语境，看片时暂停查资料是常态。你不怕看不懂，甚至有点享受看不懂带来的智力快感。",
}


# 自动解读函数
def display_paired_dimension_analysis(norm_scores):
    st.markdown("### 🎬 价值观维度解读")

    for pair, score in norm_scores.items():
        left, right = [d.strip() for d in pair.split("↔")]

        if abs(score) < 0.05:
            st.markdown(f"**{pair}：{score:.2f}（中立）**")
            st.caption("你在这个维度上展现出较为平衡或多元的倾向。")
        elif score > 0:
            st.markdown(f"**倾向：{right} 分数：{score:.2f}**")
            st.caption(subdimension_analysis.get(right, "暂无解释"))
        else:
            st.markdown(f"**倾向：{left} 分数：{-score:.2f}**")
            st.caption(subdimension_analysis.get(left, "暂无解释"))


# 问题和选项结构，每个选项带有对维度的影响
questions = [
    {
        "question": "1. 你要策划一场电影展，你会选择哪个主题？",
        "options": {
            "A. ‘时代的呐喊’——聚焦社会运动、女性权利、工人阶级抗争，展映如《她说》《燃烧女子的肖像》《浪潮》。": {"非女权 ↔ 女权": 2, "保守 ↔ 开放": 2},
            "B. ‘银河彼岸’——探索科技、人类未来、人工智能伦理，展映如《2001 太空漫游》《银翼杀手》《沙丘》。": {"经典 ↔ 先锋": 2, "大众影迷 ↔ 硬核影迷": 1, "商业 ↔ 独立": -1},
            "C. ‘现实的重量’——剖析社会阶层、民族冲突、道德困境，展映如《寄生虫》《推拿》《小偷家族》。": {"保守 ↔ 开放": 2},
            "D. ‘光影遗产’——致敬电影历史、经典叙事、传统电影美学，展映如《教父》《乱世佳人》《日出》。": {"经典 ↔ 先锋": -2, "保守 ↔ 开放": -1, "非女权 ↔ 女权": -1}
        }
    },
    {
        "question": "2. 你更容易在以下哪种情境中落泪？",
        "options": {
            "A. 弱势群体在不公平世界中挣扎或反抗": {"非女权 ↔ 女权": 2, "保守 ↔ 开放": 2},
            "B. 一段精妙的长镜头、一场光影构图精准的戏让我震撼到落泪": {"大众影迷 ↔ 硬核影迷": 2,"商业 ↔ 独立": 1},
            "C. 经典电影的致敬或复刻": {"经典 ↔ 先锋": -2, "保守 ↔ 开放": -1},
            "D. 一部电影用真挚的情感展现传统家庭纽带": {"保守 ↔ 开放": -2, "非女权 ↔ 女权": -1}
        }
    },
    {
        "question": "3. 你最讨厌哪种电影评价？",
        "options": {
            "A. “这部电影太女权了，看不下去。”": {"非女权 ↔ 女权": 2, "保守 ↔ 开放": 1},
            "B. “这电影不尊重传统价值观。”": {"保守 ↔ 开放": 2, "非女权 ↔ 女权": 1},
            "C. “这电影不好看，我看不懂。”": {"大众影迷 ↔ 硬核影迷": 2},
            "D. “这种电影套路太老了，没意思。”": {"经典 ↔ 先锋": 2}
        }
    },
    {
        "question": "4. 如果你成为导演，你最想拍哪种类型的电影？",
        "options": {
            "A. 先锋实验电影，如《圣山》": {"经典 ↔ 先锋": 2, "商业 ↔ 独立": 1, "大众影迷 ↔ 硬核影迷": 1},
            "B. 商业大片，如《阿凡达》": {"商业 ↔ 独立": -2, "大众影迷 ↔ 硬核影迷": -1},
            "C. 讲述少数民族/移民故事，如《别告诉她》《摘金奇缘》": {"保守 ↔ 开放": 2, "非女权 ↔ 女权": 1},
            "D. 表现女性坚韧但强调家庭价值观，如《母亲》《生活多美好》": {"非女权 ↔ 女权": 1, "保守 ↔ 开放": -2}
        }
    },
    {
        "question": "5. 你怎么看待“政治正确”在电影中的影响？",
        "options": {
            "A. 电影不该迎合政治正确": {"非女权 ↔ 女权": -2, "保守 ↔ 开放": -2},
            "B. 电影需要承担社会责任": {"非女权 ↔ 女权": 1, "保守 ↔ 开放": 2},
            "C. 只要是好作品，不在意": {"经典 ↔ 先锋": 2, "大众影迷 ↔ 硬核影迷": 2, "非女权 ↔ 女权": -1, "保守 ↔ 开放": -1},
            "D. 我更关注电影本身的技术和叙事": {"大众影迷 ↔ 硬核影迷": 1, "非女权 ↔ 女权": -1, "保守 ↔ 开放": -1}
        }
    },
        {
        "question": "6. 你对电影奖项的看法？",
        "options": {
            "A. 电影节评审标准有偏见，不能完全代表质量": {"经典 ↔ 先锋": 1, "保守 ↔ 开放": 1},
            "B. 电影奖项应该更多表彰文化遗产电影，如《霸王别姬》《卧虎藏龙》": {"保守 ↔ 开放": -1},
            "C. 电影奖项越来越受市场和政治影响，权威性降低": {"商业 ↔ 独立": 2, "保守 ↔ 开放": -1},
            "D. 我更关注观众评价，奖项对我来说不重要": {"商业 ↔ 独立": -2, "大众影迷 ↔ 硬核影迷": -1}
        }
    },
    {
        "question": "7. 你更愿意在哪种环境下看电影？",
        "options": {
            "A. 艺术影院，沉浸体验": {"商业 ↔ 独立": 1},
            "B. 在 IMAX 影厅刷首映，跟全场人一起喊彩蛋、鼓掌、热烈应援": {"经典 ↔ 先锋": 1, "商业 ↔ 独立": -1},
            "C. 在家独自观看，查资料、做笔记": {"大众影迷 ↔ 硬核影迷": 2},
            "D. 和朋友一起看商业大片，感受氛围": {"大众影迷 ↔ 硬核影迷": -2}
        }
    },
    {
        "question": "8. 你对翻拍经典电影的看法？",
        "options": {
            "A. 经典就是经典，翻拍毫无必要": {"经典 ↔ 先锋": -2},
            "B. 翻拍可以让电影适应现代价值观，如女性版《魔鬼终结者》": {"经典 ↔ 先锋": 1, "保守 ↔ 开放": 1},
            "C. 关键看导演创新能力": {"商业 ↔ 独立": 1},
            "D. 经典电影应该让观众自己去探索，而不是翻拍": {"大众影迷 ↔ 硬核影迷": 1}
        }
    },
    {
        "question": "9. 你最不能忍受哪种观影体验？",
        "options": {
            "A. 电影院里观众一直在说话、玩手机，影响观影体验。": {"大众影迷 ↔ 硬核影迷": 2},
            "B. 电影节上看到一些故意挑战观众耐性的‘晦涩’艺术片，感觉是自嗨。": {"大众影迷 ↔ 硬核影迷": -2},
            "C. 流媒体上看到的电影被剪辑或修改，失去了导演的原始创作意图。": {"大众影迷 ↔ 硬核影迷": 1, "经典 ↔ 先锋": -1},
            "D. 好莱坞电影里充斥着无意义的爆炸、大制作，但故事千篇一律。": {"商业 ↔ 独立": 2}
        }
    },
    {
        "question": "10. 你对好莱坞的‘漫威化’怎么看？",
        "options": {
            "A. 这是电影工业的倒退，应该恢复独立电影的地位": {"商业 ↔ 独立": 2},
            "B. 漫威电影很成功，能带来优秀的视觉体验": {"商业 ↔ 独立": -1},
            "C. 好莱坞应该有更多非英语国家的电影加入": {"保守 ↔ 开放": 2},
            "D. 超级英雄片也是电影的一种，没必要排斥": {"经典 ↔ 先锋": -1}
        }
    },
    {
        "question": "11. 你怎么看待黑白电影？",
        "options": {
            "A. 黑白电影更有质感，应该被更多人欣赏": {"大众影迷 ↔ 硬核影迷": 1},
            "B. 电影应该不断进化，黑白片是过去的遗产": {"经典 ↔ 先锋": 1},
            "C. 黑白是一种艺术表达方式，不应消失": {"经典 ↔ 先锋": -1},
            "D. 现实题材的黑白片能增加真实感": {"商业 ↔ 独立": 1}
        }
    },
    {
        "question": "12. 你更喜欢的导演是哪种类型？",
        "options": {
            "A. 突破叙事规则的导演，如戈达尔、拉斯·冯·提尔": {"经典 ↔ 先锋": 1},
            "B. 票房大导演，如诺兰、斯皮尔伯格": {"商业 ↔ 独立": -2},
            "C. 关注社会问题的导演，如是枝裕和、李沧东": {"保守 ↔ 开放": 2},
            "D. 经典大师，如库布里克、黑泽明": {"经典 ↔ 先锋": -2}
        }
    },
    {
        "question": "13. 你怎么看待电影中的暴力美学？",
        "options": {
            "A. 电影应真实呈现暴力的本质，而不是美化它": {"保守 ↔ 开放": 1},
            "B. 暴力美学是类型片的一部分，应当被视为一种电影传统": {"经典 ↔ 先锋": -1},
            "C. 暴力只是电影幻想的一部分，没必要过度道德化": {"保守 ↔ 开放": -1},
            "D. 电影可以通过解构暴力形式，挑战观众的观影习惯": {"经典 ↔ 先锋": 1}
        }
    },
    {
        "question": "14. 你怎么看待动画电影？",
        "options": {
            "A. 动画电影不只是给孩子看的，比如宫崎骏、今敏的作品": {"大众影迷 ↔ 硬核影迷": 1},
            "B. 动画电影是最有商业潜力的电影类型": {"商业 ↔ 独立": -2},
            "C. 动画是最自由的艺术形式，它可以毫无束缚地表达幻想、哲思或潜意识": {"经典 ↔ 先锋": 2},
            "D. 真正的动画经典应该经得起时间考验，能打动一代又一代人，而不是昙花一现的视觉作品": {"经典 ↔ 先锋": -2}
        }
    },
    {
        "question": "15. 你怎么看待票房与电影质量的关系？",
        "options": {
            "A. 票房不能代表电影质量": {"商业 ↔ 独立": 2},
            "B. 票房越高，说明观众越喜欢": {"商业 ↔ 独立": -1},
            "C. 电影应该服务大众，而不是精英圈子": {"大众影迷 ↔ 硬核影迷": -1},
            "D. 经典电影不一定是票房大片": {"经典 ↔ 先锋": -2}
        }
    }
]

# 用户作答
total_scores = {}
total_scores_absol = {}
for dim in dimensions:
    total_scores[dim] = 0
    total_scores_absol[dim] = 0

for idx, q in enumerate(questions):
    st.subheader(q["question"])
    st.markdown("（可多选）")
    
    for opt_text, effects in q["options"].items():
        if st.checkbox(opt_text, key=f"q{idx}_{opt_text}"):
            for dim, value in effects.items():
                total_scores[dim] += value
                total_scores_absol[dim] += abs(value)


# 提交后展示结果
if st.button("提交测试并查看结果"):
    st.markdown("## 🧭 你的价值观倾向如下：")

    normalized_scores = {}
    for dim, score in total_scores.items():
        denom = total_scores_absol[dim] if total_scores_absol[dim] != 0 else 1
        normalized_scores[dim] = score / denom

    # 构建 dataframe
    df = pd.DataFrame({
        '维度': list(normalized_scores.keys()),
        '得分': list(normalized_scores.values())
    })

    # 为了让 0 分也可视化，加一个“绘图用的微小值”
    df["绘图得分"] = df["得分"].apply(lambda x: x if abs(x) > 0.01 else 0.01)

    # 用于颜色映射
    def score_category(x):
        if x > 0:
            return "正"
        elif x < 0:
            return "负"
        else:
            return "中立"
        
    df["颜色类型"] = df["得分"].apply(score_category)

    color_scale = alt.Scale(
        domain=["正", "负", "中立"],
        range=["#1f77b4", "#ff7f0e", "#aaaaaa"]
    )

    # 条形图主体
    chart = alt.Chart(df).mark_bar().encode(
        x=alt.X('绘图得分:Q', scale=alt.Scale(domain=[-1, 1])),
        y=alt.Y('维度:N', sort='-x'),
        color=alt.Color('颜色类型:N', scale=color_scale, legend=None)
    ).properties(
        height=400
    )

    # 添加数值文本
    text = alt.Chart(df).mark_text(
        align='left',
        baseline='middle',
        dx=3,
        fontSize=12
    ).encode(
        x='绘图得分:Q',
        y=alt.Y('维度:N', sort='-x'),
        text=alt.Text('得分:Q', format=".2f")
    )

    # 添加 0 轴线
    zero_line = alt.Chart(pd.DataFrame({'得分': [0]})).mark_rule(
        color='black',
        strokeDash=[3, 3]
    ).encode(x='得分:Q')

    # 显示最终图表
    st.altair_chart(chart + text + zero_line, use_container_width=True)

    display_paired_dimension_analysis(normalized_scores)
